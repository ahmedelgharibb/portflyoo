name: Create New Website Instance

on:
  workflow_dispatch:
    inputs:
      folder_name:
        description: 'Folder name for the new website (alphanumeric, hyphens and underscores only)'
        required: true
        type: string
      site_name:
        description: 'Display name for the website'
        required: true
        type: string

jobs:
  create-website:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Validate folder name
        id: validate
        run: |
          folder_name="${{ github.event.inputs.folder_name }}"
          if [[ ! $folder_name =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Error: Folder name must contain only letters, numbers, hyphens and underscores"
            exit 1
          fi
          
          if [ -d "teacher/$folder_name" ]; then
            echo "Error: Folder 'teacher/$folder_name' already exists"
            exit 1
          fi
          
          echo "folder_name=$folder_name" >> $GITHUB_OUTPUT
          echo "site_url=https://portflyo-new.vercel.app/teacher/$folder_name/index.html" >> $GITHUB_OUTPUT
      
      - name: Create new website folder
        run: |
          folder_name="${{ steps.validate.outputs.folder_name }}"
          mkdir -p "teacher/$folder_name"
          cp -r teacher/edit-template/* "teacher/$folder_name/"
          echo "Created new website folder: teacher/$folder_name"
      
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: npm install @supabase/supabase-js
      
      - name: Register website in database
        id: register
        run: |
          folder_name="${{ steps.validate.outputs.folder_name }}"
          site_name="${{ github.event.inputs.site_name }}"
          site_url="${{ steps.validate.outputs.site_url }}"
          
          cat > register-site.js << 'EOL'
          const { createClient } = require('@supabase/supabase-js');
          
          const SUPABASE_URL = 'https://bqpchhitrbyfleqpyydz.supabase.co';
          const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxcGNoaGl0cmJ5ZmxlcXB5eWR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0NTU4ODgsImV4cCI6MjA1OTAzMTg4OH0.Yworu_EPLewJJGBFnW5W7GUsNZIONc3qOEJMTwJMzzQ';
          
          async function registerWebsite() {
            console.log('Connecting to Supabase...');
            const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            
            const folderName = process.argv[2];
            const siteName = process.argv[3];
            const siteUrl = process.argv[4];
            
            console.log(`Registering website: ${siteName} (${folderName}) at ${siteUrl}`);
            
            try {
              // Check if tables exist
              console.log('Verifying database tables...');
              try {
                const { count: websitesCount, error: websitesCheckError } = await supabase
                  .from('websites')
                  .select('*', { count: 'exact', head: true });
                
                if (websitesCheckError) {
                  console.error('Error checking websites table:', websitesCheckError.message);
                  console.log('Creating websites table...');
                  
                  // Create websites table using SQL
                  const { error: createTableError } = await supabase.rpc('create_websites_table', {});
                  
                  if (createTableError) {
                    // If RPC fails, try direct SQL
                    console.log('RPC failed, trying SQL directly...');
                    const { error: sqlError } = await supabase.sql(`
                      CREATE TABLE IF NOT EXISTS public.websites (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        site_name TEXT NOT NULL,
                        site_url TEXT NOT NULL,
                        folder_name TEXT NOT NULL,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                      );
                      -- Add any needed indexes
                      CREATE INDEX IF NOT EXISTS websites_folder_name_idx ON public.websites (folder_name);
                    `);
                    
                    if (sqlError) {
                      console.error('Failed to create websites table:', sqlError.message);
                      throw new Error(`Failed to create websites table: ${sqlError.message}`);
                    }
                  }
                  
                  console.log('Websites table created successfully');
                } else {
                  console.log('Websites table verified');
                }
                
                // Check if site_data table has the correct columns
                const { data: site_data_test, error: siteDataCheckError } = await supabase
                  .from('site_data')
                  .select('*', { count: 'exact', head: true });
                
                if (siteDataCheckError) {
                  console.error('Error checking site_data table:', siteDataCheckError.message);
                  throw new Error(`Table 'site_data' may not have the correct structure: ${siteDataCheckError.message}`);
                }
                
                console.log('Site_data table verified');
                
                // Ensure site_data table has website_id column
                try {
                  console.log('Checking site_data table structure...');
                  
                  // Check if we need to add the website_id column
                  const { error: addColumnError } = await supabase.sql(`
                    DO $$ 
                    BEGIN
                      IF NOT EXISTS (
                        SELECT 1 
                        FROM information_schema.columns 
                        WHERE table_schema = 'public' 
                        AND table_name = 'site_data' 
                        AND column_name = 'website_id'
                      ) THEN
                        ALTER TABLE public.site_data 
                        ADD COLUMN website_id UUID;
                      END IF;
                    END $$;
                  `);
                  
                  if (addColumnError) {
                    console.error('Error updating site_data table:', addColumnError.message);
                    // Continue anyway as it might be just a permission issue
                  } else {
                    console.log('Ensured site_data table has website_id column');
                  }
                } catch (structureError) {
                  console.error('Error checking site_data structure:', structureError.message);
                  // Continue anyway as we'll get a more specific error later if needed
                }
              } catch (checkError) {
                console.error('Database table verification failed:', checkError.message);
                throw checkError;
              }
              
              // Insert the website record
              console.log('Inserting website record...');
              const { data: website, error: websiteError } = await supabase
                .from('websites')
                .insert({
                  site_name: siteName,
                  site_url: siteUrl,
                  folder_name: folderName
                })
                .select()
                .single();
              
              if (websiteError) {
                console.error('Error inserting website:', websiteError.message);
                throw websiteError;
              }
              
              if (!website) {
                console.error('No website data returned after insert');
                throw new Error('Failed to create website record');
              }
              
              // Get template data
              const { data: templateWebsite, error: templateError } = await supabase
                .from('websites')
                .select('id')
                .eq('site_name', 'Default Template')
                .maybeSingle();
              
              if (templateError) {
                console.error('Error fetching template website:', templateError.message);
              }
              
              let templateData = null;
              
              if (templateWebsite) {
                const { data: templateSiteData, error: dataError } = await supabase
                  .from('site_data')
                  .select('data')
                  .eq('website_id', templateWebsite.id)
                  .maybeSingle();
                
                if (dataError) {
                  console.error('Error fetching template site data:', dataError.message);
                }
                
                if (templateSiteData) {
                  templateData = templateSiteData.data;
                }
              }
              
              // If no template data, use default
              if (!templateData) {
                console.log('Using default template data as no template found');
                templateData = {
                  "theme": {
                    "mode": "light",
                    "color": "blue"
                  },
                  "contact": {
                    "email": "",
                    "phone": "",
                    "formUrl": "",
                    "contactMessage": "",
                    "assistantFormUrl": ""
                  },
                  "results": [
                    {"name": "Mathematics", "score": 85},
                    {"name": "Physics", "score": 78},
                    {"name": "Chemistry", "score": 82},
                    {"name": "Biology", "score": 75}
                  ],
                  "personal": {
                    "name": "Teacher Name",
                    "title": "Mathematics Educator",
                    "subtitle": "Math Teacher",
                    "experience": "10+ years of teaching experience",
                    "philosophy": "I believe in creating an engaging learning environment where students can develop their mathematical thinking skills.",
                    "heroHeading": "Inspiring Minds Through Mathematics",
                    "qualifications": [
                      "Ph.D. in Mathematics Education",
                      "Master's in Applied Mathematics",
                      "Bachelor's in Mathematics"
                    ]
                  },
                  "experience": {
                    "centers": [],
                    "schools": [],
                    "platforms": []
                  },
                  "heroImage": ""
                };
              }
              
              // Insert the site data
              const { data: siteData, error: siteDataError } = await supabase
                .from('site_data')
                .insert({
                  website_id: website.id,
                  data: templateData
                })
                .select();
              
              if (siteDataError) {
                console.error('Error inserting site data:', siteDataError.message);
                throw siteDataError;
              }
              
              // Generate site-config.js content
              const configContent = 
                '/**\n' +
                ' * site-config.js\n' +
                ' * This file contains configuration specific to this website instance.\n' +
                ' * It is automatically generated by GitHub Actions on: ' + new Date().toISOString() + '\n' +
                ' */\n\n' +
                'const siteConfig = {\n' +
                '    // Website ID from the database\n' +
                '    websiteId: "' + website.id + '",\n\n' +
                '    // Site name\n' +
                '    siteName: "' + siteName + '",\n\n' +
                '    // Site URL\n' +
                '    siteUrl: "' + siteUrl + '",\n\n' +
                '    // Folder name\n' +
                '    folderName: "' + folderName + '",\n\n' +
                '    // Created timestamp\n' +
                '    createdAt: "' + website.created_at + '"\n' +
                '};\n\n' +
                'export default siteConfig;';
              
              console.log(JSON.stringify({
                websiteId: website.id,
                siteName: siteName,
                siteUrl: siteUrl,
                folderName: folderName,
                configContent: configContent
              }));
              
            } catch (error) {
              console.error('Error:', error.message || 'Unknown error occurred');
              console.error(error.stack || 'No stack trace available');
              process.exit(1);
            }
          }
          
          registerWebsite();
          EOL
          
          echo "Running website registration script..."
          if ! result=$(node register-site.js "$folder_name" "$site_name" "$site_url"); then
            echo "::error::Failed to register website in database. See error above."
            exit 1
          fi
          
          echo "Registration result: $result"
          
          # Make sure result is valid JSON before proceeding
          if ! echo "$result" | jq . > /dev/null 2>&1; then
            echo "::error::Invalid JSON result: $result"
            exit 1
          fi
          
          # Extract the config content
          config_content=$(echo $result | jq -r '.configContent')
          website_id=$(echo $result | jq -r '.websiteId')
          
          if [[ -z "$website_id" || "$website_id" == "null" ]]; then
            echo "::error::Failed to get website ID from registration result"
            exit 1
          fi
          
          # Write the site-config.js file
          echo "$config_content" > "teacher/$folder_name/site-config.js"
          
          # Output the website URL
          echo "website_id=$website_id" >> $GITHUB_OUTPUT
          echo "site_url=$site_url" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        run: |
          folder_name="${{ steps.validate.outputs.folder_name }}"
          site_url="${{ steps.validate.outputs.site_url }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add "teacher/$folder_name"
          git commit -m "feat: create new website instance for $folder_name"
          git push
      
      - name: Website Created
        run: |
          echo "âœ… New website created successfully!"
          echo "Website ID: ${{ steps.register.outputs.website_id }}"
          echo "Website URL: ${{ steps.register.outputs.site_url }}"
          echo ""
          echo "You can access your new website at:"
          echo "${{ steps.register.outputs.site_url }}" 